<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CS2 Inventory Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --tg-theme-bg-color: #1a1a1b;
            --tg-theme-secondary-bg-color: #252526;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #999;
            --tg-theme-button-color: #ff9a00;
            --accent-color: #ff9a00;
            --danger-color: #ff4d4d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Layout */
        .container { padding: 16px; padding-bottom: 80px; }
        .header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .back-btn {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 24px;
            margin-right: 12px;
            cursor: pointer;
            display: none;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .category-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #333;
            transition: transform 0.1s;
        }
        .category-card:active { transform: scale(0.95); }
        .category-icon { font-size: 32px; margin-bottom: 8px; display: block; }
        .category-name { font-weight: 600; font-size: 14px; }
        .category-count { color: var(--tg-theme-hint-color); font-size: 12px; margin-top: 4px; }

        /* Item List */
        .item-list { margin-top: 10px; }
        .item-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--accent-color);
        }
        .item-info { display: flex; flex-direction: column; max-width: 70%; }
        .item-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-sub { font-size: 12px; color: var(--tg-theme-hint-color); }
        .item-amount { font-weight: bold; color: var(--accent-color); font-size: 16px; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
        }
        .nav-btn {
            background: var(--tg-theme-secondary-bg-color);
            border: 1px solid #444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        .nav-btn:disabled { opacity: 0.3; }

        /* Detail View */
        .detail-view {
            text-align: center;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
        }
        .price-tag {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            color: #4caf50;
        }
        .main-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
        }

        /* States */
        #loader { text-align: center; margin-top: 50px; color: var(--tg-theme-hint-color); }
        .error-msg { color: var(--danger-color); text-align: center; padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <button id="back-btn" class="back-btn" onclick="goBack()">‚Üê</button>
        <h2 id="view-title" style="margin:0; font-size: 18px;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
    </div>

    <div class="container">
        <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

        <!-- –í–∏–¥ 1: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
        <div id="view-categories" class="category-grid hidden"></div>

        <!-- –í–∏–¥ 2: –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ -->
        <div id="view-items" class="hidden">
            <div id="item-container" class="item-list"></div>
            <div class="pagination">
                <button id="prev-btn" class="nav-btn" onclick="changePage(-1)">–ù–∞–∑–∞–¥</button>
                <span id="page-info">1 / 1</span>
                <button id="next-btn" class="nav-btn" onclick="changePage(1)">–í–ø–µ—Ä–µ–¥</button>
            </div>
        </div>

        <!-- –í–∏–¥ 3: –î–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
        <div id="view-detail" class="detail-view hidden">
            <div id="detail-icon" style="font-size: 64px; margin-bottom: 10px;">üì¶</div>
            <h3 id="detail-name" style="margin-bottom: 4px;">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</h3>
            <p id="detail-cat" style="color:var(--tg-theme-hint-color); margin-top: 0;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</p>
            <div id="detail-amount" style="font-size: 18px; margin-bottom: 10px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 1</div>
            <div id="price-container">
                <div id="detail-price" class="price-tag">–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω—ã...</div>
            </div>
            <button id="track-btn" class="main-btn" onclick="trackItem()">üìà –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å</button>
            <p id="track-status" style="margin-top:10px; font-size:12px; color:#4caf50;"></p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SUPABASE_URL = 'https://trufweyemrkdogsszike.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Ywujm6u8WqyG9Y4K5ANOsA_E8umiZqc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let categorizedData = {};
        let currentCategory = null;
        let currentPage = 0;
        let selectedItem = null;
        const ITEMS_PER_PAGE = 10;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            const user = tg.initDataUnsafe?.user;
            const userId = user?.id || 12345678; // –¢–µ—Å—Ç–æ–≤—ã–π ID

            try {
                const { data, error } = await supabaseClient
                    .from('user_items')
                    .select('amount, items(id, name, category)')
                    .eq('chat_id', userId);

                if (error) throw error;
                
                allData = data.filter(r => r.items);
                groupData();
                showCategories();
            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerHTML = `<div class="error-msg">–û—à–∏–±–∫–∞: ${err.message}</div>`;
            }
        }

        function groupData() {
            categorizedData = {};
            allData.forEach(row => {
                const cat = row.items.category || "üõ† –ü—Ä–æ—á–µ–µ";
                if (!categorizedData[cat]) categorizedData[cat] = [];
                categorizedData[cat].push(row);
            });
        }

        // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è ---
        function showView(viewId) {
            document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('back-btn').style.display = viewId === 'view-categories' ? 'none' : 'block';
        }

        function goBack() {
            const current = document.querySelector('.container > div:not(.hidden)').id;
            if (current === 'view-detail') showItems(currentCategory);
            else showCategories();
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ö–∞—Ç–µ–≥–æ—Ä–∏–π ---
        function showCategories() {
            const grid = document.getElementById('view-categories');
            grid.innerHTML = '';
            document.getElementById('view-title').innerText = "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏";
            
            Object.keys(categorizedData).sort().forEach(cat => {
                const count = categorizedData[cat].length;
                const icon = cat.split(' ')[0] || 'üìÇ';
                const name = cat.split(' ').slice(1).join(' ') || cat;

                const card = document.createElement('div');
                card.className = 'category-card';
                card.onclick = () => showItems(cat);
                card.innerHTML = `
                    <span class="category-icon">${icon}</span>
                    <span class="category-name">${name}</span>
                    <div class="category-count">${count} –ø–æ–∑.</div>
                `;
                grid.appendChild(card);
            });
            showView('view-categories');
        }

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ü—Ä–µ–¥–º–µ—Ç–æ–≤ ---
        function showItems(category) {
            currentCategory = category;
            currentPage = 0;
            renderItemPage();
            showView('view-items');
        }

        function renderItemPage() {
            const items = categorizedData[currentCategory];
            const start = currentPage * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = items.slice(start, end);
            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);

            document.getElementById('view-title').innerText = currentCategory;
            const container = document.getElementById('item-container');
            container.innerHTML = '';

            pageItems.forEach(row => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.onclick = () => showDetail(row);
                card.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${row.items.name}</span>
                        <span class="item-sub">CS2 Item</span>
                    </div>
                    <div class="item-amount">x${row.amount}</div>
                `;
                container.appendChild(card);
            });

            document.getElementById('page-info').innerText = `${currentPage + 1} / ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 0;
            document.getElementById('next-btn').disabled = end >= items.length;
        }

        function changePage(delta) {
            currentPage += delta;
            renderItemPage();
            window.scrollTo(0,0);
        }

        // --- –î–µ—Ç–∞–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ ---
        async function showDetail(row) {
            selectedItem = row;
            document.getElementById('view-title').innerText = "–î–µ—Ç–∞–ª–∏";
            document.getElementById('detail-name').innerText = row.items.name;
            document.getElementById('detail-cat').innerText = row.items.category;
            document.getElementById('detail-amount').innerText = `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${row.amount}`;
            document.getElementById('detail-price').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω—ã...";
            document.getElementById('track-status').innerText = "";
            
            showView('view-detail');

            // –ó–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã (Steam API –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å CORS –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
            // –í –∏–¥–µ–∞–ª–µ –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ —Ç–≤–æ–π Bot API
            try {
                const encoded = encodeURIComponent(row.items.name);
                // –≠—Ç–æ –ø—Ä–∏–º–µ—Ä. –ù–∞–ø—Ä—è–º—É—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ Steam —á–∞—Å—Ç–æ –Ω–µ –æ—Ç–¥–∞–µ—Ç –∏–∑-–∑–∞ CORS.
                // –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Å–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –±–æ—Ç–∞.
                const priceUrl = `https://steamcommunity.com/market/priceoverview/?appid=730&currency=5&market_hash_name=${encoded}`;
                
                // –í Mini App –ª—É—á—à–µ –¥–µ–ª–∞—Ç—å fetch –∫ —Å–≤–æ–µ–º—É —Å–µ—Ä–≤–µ—Ä—É Bothost, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ —Å–ø—Ä–æ—Å–∏—Ç Steam
                document.getElementById('detail-price').innerText = "–¶–µ–Ω–∞: ~15.50 —Ä—É–±."; // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
            } catch (e) {
                document.getElementById('detail-price').innerText = "–¶–µ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
            }
        }

        async function trackItem() {
            const status = document.getElementById('track-status');
            status.innerText = "‚è≥ –î–æ–±–∞–≤–ª—è—é...";
            status.style.color = "var(--accent-color)";

            try {
                const { error } = await supabaseClient
                    .from('tracking')
                    .upsert({
                        chat_id: tg.initDataUnsafe?.user?.id || 12345678,
                        item_name: selectedItem.items.name,
                        last_price: 0 // –ë–æ—Ç –æ–±–Ω–æ–≤–∏—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
                    }, { on_conflict: 'chat_id,item_name' });

                if (error) throw error;
                status.innerText = "‚úÖ –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è!";
                status.style.color = "#4caf50";
                tg.HapticFeedback.notificationOccurred('success');
            } catch (e) {
                status.innerText = "‚ùå –û—à–∏–±–∫–∞: " + e.message;
                status.style.color = "var(--danger-color)";
            }
        }

        init();
    </script>
</body>
</html>
